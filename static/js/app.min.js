function initChartContainer(){$("#container").highcharts({chart:{type:"line"},title:{text:"Machine Learning Model Statistics"},xAxis:{title:{},categories:["2017/7/1 00:00:01","2017/7/1 00:00:01","2017/7/1 01:02:01","2017/7/1 06:00:21","2017/7/1 20:20:00","2017/7/2 13:23:13","2017/7/3 10:36:22","2017/7/4 19:43:02"]},yAxis:{title:{text:"Accuracy of prediction"}},series:[{name:"Random Forest",data:[43,60,73,79,84,86,87,88]},{name:"Radial Basrs Function Support Vector Classification",data:[55,70,82,87,89,91,92,92.6]},{name:"Multinomial Navie Bayes",data:[60,63,65,66.6,68,69,70.8,73]},{name:"Linear Support Vector Classification",data:[77,82,84,86,87,88.8,89.3,89.5]},{name:"Gaussian Naive Bayes",data:[81,86,89.3,92,94.5,95.8,97,98.7]}]})}function btnAddHover(){$("#dropdownMenu1").click(function(){toastr.info("Choose a algorithm model to set it up!")})}function btnAddSubject(){$("#btnAddSubject").click(function(){toastr.info("Add a new subject...")})}function addPseudoClass(){$("#btnAddSubject").click(function(){toastr.info("Add a new subject...")}),css("p:after{content:'修改一下'}")}function settingPageAddImgBefore(e,t){t=document.createElement("style"),t.innerText=e,document.body.appendChild(t)}var app=angular.module("MachineLearningPOC",["ui.bootstrap","ngFileUpload","ngMaterial"]);app.controller("MainController",["$scope","$http","filterFilter","$filter","$timeout",function(e,t,n,o,r){function a(){$(".highcharts-credits").html("")}function i(){S.keyWordArray.keywords.forEach(function(t,n){0==n&&(t.selected=!0,e.currentKeyword=t),t.values.forEach(function(e){void 0==e.feedback&&(e.feedback={}),e.feedback.type=e.type,e.feedback.result="target",void 0==e["new"]&&(e["new"]=!1)})})}function s(){S.subjects=[{name:"Finance",description:"Description of Finance",imageLocation:"./images/finance.jpg"},{name:"Medical",description:"Description of Medical",imageLocation:"./images/medical.jpg"},{name:"Resource",description:"Description of Resource",imageLocation:"./images/resource.jpg"},{name:"Law",description:"Description of Law",imageLocation:"./images/law-books2.jpg"}]}function c(t){switch(t){case"Law":e.reportList=[{name:"何某某犯行贿罪一审刑事判决书",id:"596703bef1156f318437db6b",size:"163 KB",completionRate:10,processDate:"2015.07.27",model:"Model 1",reportScore:80},{name:"周顺明受贿二审刑事判决书",id:"596703bff1156f318437db6c",size:"57 KB",completionRate:11,processDate:"2010.01.26",model:"Model 2",reportScore:60},{name:"开封康信医疗器械有限责任公司、王敬敬对单位行贿一审刑事判决书",id:"596703bff1156f318437db6d",size:"156 KB",completionRate:92,processDate:"2016.06.11",model:"Model 3",reportScore:50},{name:"方职务侵占罪申诉刑事决定书",id:"596703c0f1156f318437db6e",size:"153 KB",completionRate:93,processDate:"2015.05.02",model:"Model 4",reportScore:90},{name:"李某介绍贿赂罪一审刑事判决书",id:"596703c0f1156f318437db6f",size:"155 KB",completionRate:100,processDate:"2016.04.03",model:"Model 2",reportScore:99}];break;default:e.reportList=[{name:"Accenture_Annual_Report_2016_Form_10-K",id:"596703bef1156f318437db6b",size:"3775 KB",completionRate:45,processDate:"2015.07.27",model:"Model 1",reportScore:8},{name:"Acuity_Brands_Annual_Report_2016_Form_10-K",id:"596703bff1156f318437db6c",size:"5433 KB",completionRate:64,processDate:"2010.01.26",model:"Model 2",reportScore:7},{name:"Adobe_Systems_Annual_Report_2016_Form_10-K",id:"596703bff1156f318437db6d",size:"5767 KB",completionRate:44,processDate:"2016.06.11",model:"Model 3",reportScore:1},{name:"Akamai_Technologies_Annual_Report_2016_Form_10-K",id:"596703c0f1156f318437db6e",size:"4802 KB",completionRate:92,processDate:"2015.05.02",model:"Model 4",reportScore:8},{name:"Alphabet Inc._Annual-Report_2016",id:"596703c0f1156f318437db6f",size:"5292 KB",completionRate:100,processDate:"2016.04.03",model:"Model 5",reportScore:10}]}}function l(e){switch(e){case"Law":S.keyWordArray={id:0,name:"何某某犯行贿罪一审刑事判决书",reportScore:"50.0",is10K:"TRUE",completionRate:"0",scoreRule:"Test(受贿*0.1)*0.95*100",predictResult:[{page_text:"",paragraph_number:34,line_text:"",paragraph_text:"被告人何某某犯行贿罪，判处有期徒刑二年。",page_path:"",keyword:"Law Verdicts"}],keywords:[{keyword:"行贿",values:[{page:"14",line:"",color:"yellow",type:"paragraphs",paragraph:34,textToHighlight:"（一）行贿数额在二十万元以上不满一百万元的",feedback:{result:"",type:""}},{page:"14",line:"",color:"yellow",type:"paragraphs",paragraph:34,textToHighlight:"（二）行贿数额在十万元以上不满二十万元，并具有下列情形之一的",feedback:{result:"",type:""}}]}]};break;default:S.keyWordArray={id:0,name:"[Test]Apple_Annual_Report_2016_Form_10-K",keywords:[{keyword:"Total Revenue",values:[{page:59,line:5,color:"green",textToHighlight:"Total revenues ........................................................................................     7,000,132 4,046,0253,198,356",feedback:{result:"target",type:"lines"}},{page:80,line:32,color:"yellow",textToHighlight:"$1123.32",feedback:{result:"target",type:"lines"}},{page:59,line:32,color:"yellow",textToHighlight:"6,350,766 3,740,973 3,007,012 Energy generation and storage",feedback:{result:"target",type:"lines"}},{page:11,line:0,color:"green",textToHighlight:"Feedback text","new":!0,feedback:{result:"target",type:"lines"}}]},{keyword:"Total Revenue test",values:[{page:59,line:5,color:"green",textToHighlight:"Total revenues  7,000,132 4,046,0253,198,356",feedback:{result:"target",type:"lines"}}]},{keyword:"Total Revenue test",values:[{page:59,line:5,color:"green",textToHighlight:"Total revenues  7,000,132 4,046,0253,198,356",feedback:{result:"target",type:"lines"}}]}]}}i()}function d(){S.keyWordSettingArray={subjectName:"Finance",keywords:["Total Revenue","Asset","Net Income"],models:[{modelName:"Logistic",imgSrc:"./images//logistic-model.png"},{modelName:"Naive Bayes",imgSrc:"./images/naive-bayes-model.png"},{modelName:"Support Vector Classification",imgSrc:"./images/support-vector-classification-model.png"},{modelName:"Random Forest",imgSrc:"./images/random-forest-model.png"}]}}function u(e,t,n){for(var o=0;o<e.length;o++)if(e[o]==n){e.splice(o,1);break}}function f(){var e=$(document.createElement("IFRAME"));e.attr("id","pdf-iframe"),e.attr("frameborder",0),e.attr("class","pdf-content"),e.attr("src","./PDFJS/web/viewer.html"),e.appendTo("#divPDFContainer");document.getElementById("pdf-iframe").contentWindow.document;$("#pdf-iframe").bind("load",function(){p()})}function p(){$("#pdf-iframe").contents().find("#viewerContainer").mouseup(function(e){var t,n=document.getElementById("pdf-iframe").contentWindow,o=document.getElementById("pdf-iframe").contentDocument.getElementById("pageNumber").value;n.getSelection&&(t=n.getSelection()),""!=t.toString()&&m(t.toString(),o)})}function g(e){e.src="about:blank";try{e.contentWindow.document.write(""),e.contentWindow.document.clear()}catch(t){}e.parentNode.removeChild(e)}function m(t,n){var o=S.keyWordArray.keywords.indexOf(e.currentKeyword),r=S.keyWordArray.keywords[o];void 0!=r&&(void 0==r.values&&(r.values=[]),r.values.push({page:n,line:0,color:"green",textToHighlight:t,"new":!0,feedback:{result:"target",type:"lines"}})),e.$apply()}function y(n){e.showInfoMessage("Loading report data..."),t.get("/api/reports/"+n+"?subject="+e.subject).then(function(t){S.keyWordArray=t.data,e.clearInfoMessage()},function(t){e.showErrorMessage()})["finally"](function(){i()})}function h(){for(var e=$("#pdf-iframe").contents().find(".page"),t=1;t<=e.length;t++)$(e[t-1]).attr("id","pf"+t)}function w(e){h(),document.getElementById("pdf-iframe").contentWindow.location.hash="#pf"+e,document.getElementById("pdf-iframe").contentWindow.location.hash=""}function v(t){for(var n="pf"+e.previousKeywordItem.page,o=document.getElementById("pdf-iframe").contentWindow.document.getElementById(n),r=$(o).children(".textLayer"),a=$(r).find("div"),i=0;i<e.highlightedDivIndexs.length;i++)$(a[e.highlightedDivIndexs[i]]).css("background-color","transparent")}function b(t){var n="pf"+t.page,o=document.getElementById("pdf-iframe").contentWindow.document.getElementById(n),r=$(o).children(".textLayer"),a=$(r).find("div"),i="",s="",c="";"Law"==e.subject?c=t.textToHighlight:(s=new RegExp("[^0-9a-zA-Z$,]","g"),c=t.textToHighlight.replace(s,""));for(var l=!0,d=0;d<a.length;d++)i+="Law"==e.subject?a[d].innerHTML.toString():a[d].innerHTML.toString().replace(s,""),a[d].innerHTML.indexOf(c)>0&&($(a[d]).css("background-color","yellow"),l=!1);if(l){for(var u=c.length,f=[],p=i.length,g=0,m=[],y=0;p-u>y;y++){var h=M(i.substr(y,u),c);g>h||(h>g?(g=h,m=[],m.push(i.substr(y,u))):m.push(i.substr(y,u)))}for(var d=0;d<m.length;d++){var w=m[d];f=[];for(var v="",b=0;b<a.length;b++){var k="";if(k="Law"==e.subject?a[b].innerHTML:a[b].innerHTML.replace(s,""),""!==k){var S=w.indexOf(k),A=k.indexOf(w.replace(v,""));if(0>S&&0>A)f.length>0&&(f=[],v="");else{v+=k,f.push(b);for(var R=b+1;R<a.length&&(k="Law"==e.subject?a[R].innerHTML:a[R].innerHTML.replace(s,""),""==k);R++);var I=v.length+k.length;if(w.length<I&&k.indexOf(w.replace(v,""))<0)break}}}for(var d=0;d<f.length;d++)$(a[f[d]]).css("background-color","yellow");e.highlightedDivIndexs=f,e.previousKeywordItem=t}}}function k(e,t){if(0==e.length)return t.length;if(0==t.length)return e.length;for(var n=[],o=0;o<=t.length;o++)n[o]=[o];for(var r=0;r<=e.length;r++)n[0][r]=r;for(o=1;o<=t.length;o++)for(r=1;r<=e.length;r++)n[o][r]=t.charAt(o-1)==e.charAt(r-1)?n[o-1][r-1]:Math.min(n[o-1][r-1]+1,Math.min(n[o][r-1]+1,n[o-1][r]+1));return n[t.length][e.length]}function M(e,t){var n=k(e,t);return 1-n/Math.max(e.length,t.length)}var S=this;e.currentReport={},e.currentKeyword={},e.keyWordValue={},e.subject="",e.previousKeywordItem="",e.highlightedDivIndexs=[],e.modelSeletedImgSrc="./images//logistic-model.png",e.modelSeletedTitle="Select a model",S.unCollapsedFeedback=!0,S.completionRateFilterValue=100,S.language="",S.placeholderReportList="";var A=!1;d(),A&&(s(),S.viewState="Annual Report Documents"),S.fullTextSearch=function(){var e=$("#searchBar input[type='text']").val(),n=e.split(" "),o=new Array;n.forEach(function(e,t,n){""==e||" "==e||o.push(e)}),o.forEach(alert);var r=o[0],a=o[1];console.log(r+" "+a),t.get("/api/verdicts/?person_name="+r+"&company_name="+a).then(function(e){},function(e){})["finally"](function(){})},S.navigateTo=function(t,n){switch(S.viewState=t,t){case"Settings":e.subject=n;break;case"Annual Report Documents":e.subject=n,e.getReportsNameList(n);break;case"Subject Selection":e.getSubjects();break;default:e.subject=n}"Settings"==t&&a(),"Law"==n?(S.language="Chinese",S.placeholderReportList="搜索判决书"):(S.language="English",S.placeholderReportList="Search Report")},S.validationResultButtonToggle=function(e){return"non-target"==e?!1:!0},S.IsKeywordTarget=function(e){return"non-target"==e?!1:!0},S.toggleCompletionRateFilter=function(){S.completionRateFilterValue=100==S.completionRateFilterValue?101:100},e.lessThan=function(e,t){return function(n){return n[e]<t}},S.selectModel=function(t,n){e.modelSeletedImgSrc=n.imgSrc,e.modelSeletedTitle=n.modelName},S.addKeywordSetting=function(e){var t=!0,n=S.keyWordSettingArray.keywords;(void 0==e||""==e)&&(toastr.warning("The keyword can not be empty!"),t=!1);for(var o=0;o<n.length;o++)if(n[o]==e){toastr.warning("The keyword has exited!"),t=!1;break}t&&S.keyWordSettingArray.keywords.push(e)},S.editKeywordSetting=function(e,t){var n=prompt("Editing...",t);null!=n&&""!=n&&($("tr:eq("+e+") td:first").html(n),S.keyWordSettingArray.keywords[e]=n)},S.deleteKeywordSetting=function(e,t){if(confirm("Are you sure you want to delete this item?")){{S.keyWordSettingArray.keywords[e]}$("tr:eq("+e+")").remove(),u(S.keyWordSettingArray.keywords,e,t)}},e.deleteKeywordValuesItem=function(e,t){var n=_.find(S.keyWordArray.keywords,e).values;_.remove(n,function(e){return e==t})},e.hasSuggestions=function(e){var t=!1;return e.values.forEach(function(e){1==e["new"]&&(t=!0)}),t},e.getReportsNameList=function(n){A?c(n):(e.showInfoMessage("Loading report list"),t.get("/api/reports/?subject="+n).then(function(t){e.reportList=t.data},function(t){e.clearInfoMessage(),e.showErrorMessage()})["finally"](function(){e.clearInfoMessage()}))},e.navigateToKeyword=function(t){e.currentKeyword=S.keyWordArray.keywords[t],e.keyWordValue=S.keyWordArray.keywords[t].values,S.deselectKeywords(),S.keyWordArray.keywords[t].selected=!0,e.locatePdfPageAndHighLight(e.keyWordValue[0])},e.isEmptyObject=function(e){return 0==Object.keys(e)},e.addFeedback=function(e){var t=S.keyWordArray.keywords.indexOf(e);t>=0&&void 0==S.keyWordArray.keywords[t].suggestions&&(S.keyWordArray.keywords[t].suggestions=[]),S.keyWordArray.keywords[t].suggestions.push("")},S.deselectKeywords=function(e){S.keyWordArray.keywords.forEach(function(e){e.selected=!1})},e.submitCorrectionForKeyword=function(n){var o=_.filter(n.values,function(e){return"non-target"==e.feedback.result||1==e["new"]}),r={keyword:n.keyword,values:o},a={id:S.keyWordArray.id,name:S.keyWordArray.name,file:S.keyWordArray.file,keywords:[r]};t.post("/api/feedback/",a).then(function(t){e.showSuccessMessage("Feedback submitted")},function(t){e.showSuccessMessage("Feedback submitted")})["finally"](function(){})},e.trainModel=function(){e.showInfoMessage("Training in progress..."),t.post("/api/model/train").then(function(t){e.showSuccessMessage("Model trained")},function(t){e.showErrorMessage()})["finally"](function(){e.clearInfoMessage()})},e.predictModel=function(){e.showInfoMessage("Prediction in progress..."),t.post("/api/model/predict").then(function(t){e.showSuccessMessage("Model predicted")},function(t){e.showErrorMessage()})["finally"](function(){e.clearInfoMessage()})},e.navigateToReport=function(t,n){S.keyWordArray=[];var o="";switch(e.subject){case"Law":o="../../documents/pdf-docx-law-verdicts/"+n+".pdf";break;default:o="../../documents/pdf-finance-annual-reports-test/"+n+".pdf"}window.parent.filePath=o,e.currentReport.filePath=o,e.currentReport.name=n,S.navigateTo("Report Page",e.subject);var r=document.getElementById("pdf-iframe");r&&g(r),f(),A?l(e.subject):y(t)},e.navigateToSubjectAdd=function(){S.navigateTo("Subject Add")},e.addBeforeBackgroud=function(e){console.log(e);var t=document.createElement("style");t.innerText=".subjectSelection .txtBlur:before{background:url(."+e+")}",document.body.appendChild(t)},e.getSubjects=function(){A,s()},e.locatePdfPageAndHighLight=function(t){w(t.page),"pages"!==t.type&&(void 0!=e.previousKeywordItem&&e.previousKeywordItem!=t&&v(e.previousKeywordItem),r(function(){b(t)},1e3))},e.showSuccessMessage=function(e){S.successMessage=e+" successfully!",r(function(){S.successMessage=null},5e3)},e.showInfoMessage=function(e){S.infoMessage=e},e.clearInfoMessage=function(){S.infoMessage=null},e.showErrorMessage=function(e){S.errorMessage=void 0!=e?e:"An error has occured!",r(function(){S.errorMessage=null},5e3)},S.navigateTo(A?"Subject Selection":"Subject Selection")}]),app.controller("UploadCtrl",["$scope","Upload","$timeout","$http",function(e,t,n,o){e.uploadFiles=function(r,a){e.f=r,null!=r&&(r.uploadInfoMessage=null,r.uploadSuccessMessage=null,r.uploadErrorMessage=null),e.errFile=a&&a[0],r&&(r.uploadInfoMessage="Uploading file: "+r.name,r.uploadSuccessMessage=null,r.uploadErrorMessage=null,r.upload=t.upload({url:"/api/upload/import",data:{file:r}}),r.upload.then(function(e){r.uploadSuccessMessage=e.data[0],r.uploadInfoMessage="Processing import",r.uploadErrorMessage=null;var t=new Object;t.fileName=e.data[1],t.clientId=client.id,o.post("/api/upload/process",t).then(function(e){r.uploadSuccessMessage=e.data,r.uploadInfoMessage=null,r.uploadErrorMessage=null},function(e){r.uploadInfoMessage=null,r.uploadSuccessMessage=null,r.uploadErrorMessage=e.data})["finally"](function(){}),n(function(){r.result=e.data})},function(t){t.status>0&&(r.uploadErrorMessage=t.data,r.uploadInfoMessage=null,r.uploadSuccessMessage=null,e.errorMsg=t.status+": "+t.data)},function(e){r.progress=Math.min(100,parseInt(100*e.loaded/e.total))}))}}]),app.directive("waitCursor",function(){return{template:'<i class="fa fa-circle-o-notch fa-spin" style="font-size:20px;"></i>'}}),app.directive("checkmark",function(){return{template:'<i class="fa fa-check" style="font-size:20px;"></i>'}}),app.directive("warning",function(){return{template:'<i class="fa fa-warning" style="font-size:20px;"></i>'}}),app.directive("successMessage",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="alert alert-success col-xs-12" ng-transclude></div>'}}),app.directive("infoMessage",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="alert alert-info col-xs-12" ng-transclude></div>'}}),app.directive("errorMessage",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="alert alert-danger col-xs-12" ng-transclude></div>'}}),function(){$(btnAddHover),$(initChartContainer),$(btnAddSubject)}();